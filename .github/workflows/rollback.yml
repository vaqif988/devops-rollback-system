name: Rollback Release

on:
  workflow_dispatch:
    inputs:
      revision:
        description: "Helm revision number to rollback to (empty = previous)"
        required: false
        default: ""

jobs:
  rollback:
    runs-on: ubuntu-latest

    env:
      RELEASE_NAME: myapp
      NAMESPACE: default

    steps:
      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "v1.30.0"

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: "v3.15.2"

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" > ~/.kube/config

      - name: Show Helm history
        run: |
          helm history $RELEASE_NAME -n $NAMESPACE

      - name: Rollback release
        run: |
          if [ -z "${{ github.event.inputs.revision }}" ]; then
            echo "No revision provided. Rolling back to previous revision..."
            # Helm-də 'helm rollback NAME 0' → əvvəlki versiyaya qayıdır
            helm rollback $RELEASE_NAME 0 -n $NAMESPACE
          else
            echo "Rolling back to revision ${{ github.event.inputs.revision }}..."
            helm rollback $RELEASE_NAME ${{ github.event.inputs.revision }} -n $NAMESPACE
          fi
