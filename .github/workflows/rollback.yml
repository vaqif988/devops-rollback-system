name: Auto Rollback

on:
  workflow_dispatch:  # Manual run (button in GitHub Actions)

env:
  IMAGE_REPO: docker.io/${{ secrets.REGISTRY_USER }}/myapp

jobs:
  rollback:
    runs-on: ubuntu-latest

    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.REGISTRY_USER }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Get image tags from Docker Hub
        run: |
          echo "Getting tags..."
          TAGS=$(curl -s https://hub.docker.com/v2/repositories/${{ secrets.REGISTRY_USER }}/myapp/tags/?page_size=100 | jq -r '.results[].name')
          echo "$TAGS" > tags.txt
          echo "Available tags:"
          cat tags.txt

      - name: Determine previous tag
        run: |
          # Sort tags by creation order (latest first)
          PREVIOUS=$(sed -n '2p' tags.txt)   # second line = previous version
          echo "Previous tag is: $PREVIOUS"
          echo "PREVIOUS_TAG=$PREVIOUS" >> $GITHUB_ENV

      - name: Pull previous image
        run: |
          docker pull ${{ env.IMAGE_REPO }}:${{ env.PREVIOUS_TAG }}

      - name: Retag previous version as latest
        run: |
          docker tag ${{ env.IMAGE_REPO }}:${{ env.PREVIOUS_TAG }} ${{ env.IMAGE_REPO }}:latest

      - name: Push rolled-back latest image
        run: |
          docker push ${{ env.IMAGE_REPO }}:latest

      - name: Done
        run: echo "Rollback to previous version completed successfully!"
